<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8849YBK81C"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-8849YBK81C');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Sergey Grishuk</title>
    
    <link href="https://unpkg.com/prismjs@1.30.0/themes/prism-tomorrow.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <script src="https://kit.fontawesome.com/2e0ebe0f0a.js" crossorigin="anonymous"></script>

</head>

<body>
    <header class="container">
        <nav>
            <ul>
                <li><a class="contrast title-name" href="/">Sergey Grishuk</a></li>
            </ul>
            <ul>
                <li><a class="contrast" href="/#about">About</a></li>
                <li><a class="contrast" href="/#posts">Posts</a></li>
                <li><a class="contrast" href="/#projects">Projects</a></li>
                <li><a class="contrast" href="/#contact">Contact</a></li>

                <li class="divider"></li>

                <li>
                    <a target="_blank" rel="noopener noreferrer" href="https://github.com/user-at-host">
                        <i class="fa-brands fa-github"></i>
                    </a>
                </li>
                <li>
                    <a target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/sergey-grishuk-0701a1193/">
                        <i class="fa-brands fa-linkedin"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <article id="posts">
            <h2>Systemd Service Hardening - Introduction</h2>
            <hr />

            <h3>Introduction</h3>

            <p>Systemd provides a set of settings that can be applied to a service to harden it. 
                Those settings allow controlling privileges, networking, file system access and more. 
                For example, a service can be “chrooted” into a directory and not be able to access any of the file system files, 
                or it can be isolated from the network completely. To make the process of the hardening easier, 
                systemd comes with a built-in command that allows to check and score the security level of each service on the system, 
                which is helpful in the process of the hardening.</p>

            <h3>Service Security Analysis</h3>

            <p>As mentioned previously, systemd has a built-in command for service analysis. 
                The command is <code>systemd-analyze security</code> which lists all the existing services and their score. 
                Below is an example taken from Ubuntu 24.</p>

            <img alt="systemd analyze security output" class="post-image" src="/images/systemd-analyze-security-output.PNG">

            <p>The same command followed by the name of the service provides an in depth look into its security configurations. 
                For example, the <code>systemd-analyze security ssh</code> 
                command shows the security settings of the ssh service.</p> 
                <p><i>On RHEL based distributions the service is named <code>sshd</code>.</i></p>

            <img alt="systemd analyze security ssh output" class="post-image" src="/images/systemd-analyze-security-ssh.PNG">

            <p>The output provides the names of the settings (same as it is written in the .service file), 
                a short description for each one of them and the exposure score. 
                When dealing with service hardening it is important to keep in mind the actual purpose of the service, 
                maybe it needs access to the file system, or it requires root privileges and so on. 
                Restricting all of the available settings will probably result in an unusable service.</p>

            <h3>Applying Service Hardening</h3>
            <p>To apply any of the available settings, 
                open the service file via a text editor and add the needed configuration under the <code>[Service]</code> section. 
                Once the settings are written, 
                run the <code>systemctl daemon-reload</code> command followed by a <code>systemctl restart SERVICE_NAME</code> command.</p>

            <p>The location of the service file can be found by running the <code>systemctl status SERVICE_NAME</code> command. 
                For example, the SSH service file on Ubuntu is located under <code>/usr/lib/systemd/system/</code> as seen in the output next to <code>loaded</code>.</p>

            <img alt="systemctl status ssh" class="post-image" src="/images/systemctl-status-ssh.PNG">

            <p>As an example, I will create a new service named <code>my-api</code>. 
                This is a minimalistic FastAPI application for demonstration purposes. 
                The code of the application is written in Python and looks as follows.</p>

            <pre class="code-box">
                <code class="language-python code-box">
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def root():
    return {"msg": "The API is running"}
                </code>
            </pre>

            <p>To make a service out of it, I will use the following basic template for a <code>.service</code> file.</p>

            <pre class="code-box">
                <code class="language-systemd code-box">
[Unit]
Description=My API
After=network.target

[Service]
ExecStart=/usr/bin/uvicorn /opt/my-api/my-api.py

[Install]
WantedBy=multi-user.target
                </code>
            </pre>

            <p>After placing the service file under the <code>/usr/lib/systemd/system</code> directory and running <code>systemctl daemon-reload</code> the system recognizes the new service, 
                this can be verified using the <code>systemctl status my-api.service</code> command.</p>

            <img alt="systemctl-status-my-api" src="/images/systemctl-status-myapi.PNG" class="post-image"/>

            <p>Running the <code>systemd-analyze security my-api</code> command shows that the service is not secured at all.</p>

            <img alt="systemd-analyze-security-my-api" class="post-image" src="/images/systemd-analyze-security-my-api.png" />

            <p>To apply any of the security settings, add them under the <code>[Service]</code> section.</p>

            <pre class="code-box">
                <code class="language-systemd code-box">
[Unit]
Description=My API
After=network.target

[Service]
User=my-user
Group=my-user
ExecStart=/usr/bin/uvicorn /opt/my-api/my-api.py
RootDirectory=/my-api
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
                </code>
            </pre>
        </article>
    </main>

    <script src="https://unpkg.com/prismjs@1.30.0/components/prism-core.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
